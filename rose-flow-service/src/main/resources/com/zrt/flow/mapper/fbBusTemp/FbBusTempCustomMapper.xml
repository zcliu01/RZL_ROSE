<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.zrt.flow.mapper.fbBusTemp.FbBusTempCustomMapper">
	
	<!--获取流程列表-->
	<select id="getFbBusTempList" resultType="java.util.HashMap">
       	SELECT
			tt.id,
			tt.t_code,
			tt.t_name,
			tt.t_desc,
			tt.t_enabled,
			t1.id t_type_id,
			t1.t_name t_type_name,
			t2.id parent_t_type_id,
			t2.t_name parent_t_type_name,
			tt.create_date_time,
			tt.update_date_time,
			fm.id fm_id,
			fm.t_name fm_name,
			tt.model_id,
			tt.project_flag,
			tt.handle_flag
		FROM
			fb_bus_template tt
		JOIN fb_bus_type t1 ON tt.f_b_t_id = t1.id
		JOIN fb_bus_type t2 ON tt.parent_id = t2.id
		LEFT JOIN fb_bus_fm bm ON tt.id=bm.fb_id
		LEFT JOIN fm_bus_template fm ON fm.id=bm.fm_id
		WHERE
			tt.t_enabled = '1' 
		<if test="t_name != null and t_name !=''">
                AND tt.t_name  LIKE CONCAT ('%',#{t_name},'%')
		</if>
		<if test="t_type_id != null and t_type_id !=''">
                AND t1.id =#{t_type_id}
		</if>
		<if test="t_type_name != null and t_type_name !=''">
                AND t1.t_name LIKE CONCAT(#{t_type_name},'%')
		</if>
		<if test="parent_t_type_name != null and parent_t_type_name !=''">
                AND t2.t_name LIKE CONCAT(#{parent_t_type_name},'%')
		</if>      
		order by tt.create_date_time desc
	</select>
	
	<!--获取运行流程列表-->
	<select id="getRunList" resultType="java.util.HashMap">
       	SELECT
			tt.id,
			tt.t_code,
			tt.t_name,
			tt.t_desc,
			tt.t_enabled,
			tt.model_id,
			t1.id t_type_id,
			t1.t_name t_type_name,
			t2.id parent_t_type_id,
			t2.t_name parent_t_type_name,
			tt.create_date_time,
			tt.update_date_time,
			fm.id fm_id,
			fm.t_name fm_name,
			tt.project_flag,
			tt.handle_flag
		FROM
			fb_bus_template tt
		JOIN fb_bus_type t1 ON tt.f_b_t_id = t1.id
		JOIN fb_bus_type t2 ON tt.parent_id = t2.id
		LEFT JOIN fb_bus_fm bm ON tt.id=bm.fb_id
		LEFT JOIN fm_bus_template fm ON fm.id=bm.fm_id
		WHERE
			tt.t_enabled = #{t_enabled}
		<if test="t_name != null and t_name !=''">
                AND tt.t_name  LIKE CONCAT (#{t_name},'%')
		</if>
		<if test="t_type_id != null and t_type_id !=''">
                AND t1.id =#{t_type_id}
		</if>
		<if test="t_type_name != null and t_type_name !=''">
                AND t1.t_name LIKE CONCAT(#{t_type_name},'%')
		</if>
		<if test="parent_t_type_name != null and parent_t_type_name !=''">
                AND t2.t_name LIKE CONCAT(#{parent_t_type_name},'%')
		</if>      
		order by tt.create_date_time desc

	</select>
	<!--获取运行流程列表-->
	<select id="applyList" resultType="java.util.HashMap">
       	SELECT DISTINCT
	tt.id,
	tt.t_code,
	tt.t_name,
	tt.t_desc,
	tt.t_enabled,
	tt.model_id,
	t1.id t_type_id,
	t1.t_name t_type_name,
	t2.id parent_t_type_id,
	t2.t_name parent_t_type_name,
	tt.create_date_time,
	tt.update_date_time,
	fm.id fm_id,
	fm.t_name fm_name,
	tt.project_flag,
	tt.handle_flag
FROM
	fb_bus_user_role fbur
JOIN fb_bus_role fbr ON fbur.role_id = fbr.role_id
JOIN fb_role_template frt ON fbur.role_id = frt.role_id
JOIN fb_bus_template tt ON frt.t_code = tt.t_code
JOIN fb_bus_type t1 ON tt.f_b_t_id = t1.id
JOIN fb_bus_type t2 ON tt.parent_id = t2.id
LEFT JOIN fb_bus_fm bm ON tt.id = bm.fb_id
LEFT JOIN fm_bus_template fm ON fm.id = bm.fm_id
		WHERE
			tt.t_enabled = #{t_enabled}
			 AND fbr.role_type = '2'
			AND fbur.emp_id = #{emp_id}
		<if test="t_name != null and t_name !=''">
                AND tt.t_name  LIKE CONCAT ('%',#{t_name},'%')
		</if>
		<if test="t_type_id != null and t_type_id !=''">
                AND t1.id =#{t_type_id}
		</if>
		<if test="t_type_name != null and t_type_name !=''">
                AND t1.t_name LIKE CONCAT('%',#{t_type_name},'%')
		</if>
		<if test="parent_t_type_name != null and parent_t_type_name !=''">
                AND t2.t_name LIKE CONCAT('%',#{parent_t_type_name},'%')
		</if>      
		order by tt.create_date_time desc

	</select>
	<!--获取运行流程明细-->
	<select id="getRunDetail" resultType="java.util.HashMap">
       		SELECT
				tt.id,
				tt.t_code,
				tt.t_name,
				tt.t_desc,
				tt.t_enabled,
				tt.version,
				tt.create_date_time pro_date_time,
				fm.id fm_id,
				fm.t_name fm_name
			FROM
				fb_bus_template tt
			LEFT JOIN fb_bus_fm bm ON tt.id = bm.fb_id
			LEFT JOIN fm_bus_template fm ON fm.id = bm.fm_id
			WHERE
				tt.t_code = #{t_code}
			AND tt.t_enabled = #{t_enabled}
	</select>
  	
</mapper>