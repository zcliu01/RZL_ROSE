<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.zrt.flow.mapper.flowEntrust.FlowEntrustCustomMapper">
	
	<!--获取委托流程列表-->
	<select id="getEntrustList" resultType="java.util.HashMap">
       	SELECT
			tt.id fb_id,
			tt.t_code,
			tt.t_name,
			tt.t_desc,
			tt.t_enabled,
			tt.model_id,
			t1.id t_type_id,
			t1.t_name t_type_name,
			t2.id parent_t_type_id,
			t2.t_name parent_t_type_name,
			fm.id fm_id,
			fm.t_name fm_name,
  			fe.id ent_id,
 		    fe.ent_emp_id entrusted_id,
  			fe.ent_emp_name entrusted_name,
  			(CASE WHEN fe.id IS NOT NULL AND fe.check_emp_id=#{emp_id} THEN '1' ELSE '0' END) entrust_status
		FROM
			fb_bus_template tt
		JOIN fb_bus_type t1 ON tt.f_b_t_id = t1.id
		JOIN fb_bus_type t2 ON tt.parent_id = t2.id
		LEFT JOIN fb_bus_fm bm ON tt.id = bm.fb_id
		LEFT JOIN fm_bus_template fm ON fm.id = bm.fm_id
		LEFT JOIN (SELECT * FROM fb_bus_entrust fe WHERE fe.check_emp_id=#{emp_id} and fe.ent_enabled='1') fe 
		ON fe.fb_code = tt.t_code
		WHERE
			tt.t_enabled = '2'
		<if test="t_code != null and t_code !=''">
                AND tt.t_code =  #{t_code}
		</if>
		<if test="t_name != null and t_name !=''">
                AND tt.t_name  LIKE CONCAT (#{t_name},'%')
		</if>
		<if test="entrusted_name != null and entrusted_name !=''">
                AND fe.ent_emp_name =#{entrusted_name}
		</if>
		<if test="entrust_status != null and entrust_status !=''">
			<if test="entrust_status == 0">
	                AND fe.id is null
			</if>
			<if test="entrust_status == 1">
	                AND fe.id is not null
			</if>
		</if>
		<if test="t_type_name != null and t_type_name !=''">
                AND t1.t_name LIKE CONCAT(#{t_type_name},'%')
		</if>
		<if test="parent_t_type_name != null and parent_t_type_name !=''">
                AND t2.t_name LIKE CONCAT(#{parent_t_type_name},'%')
		</if>   
	</select>
	
	
	<!--获取我委托的和委托我的流程列表-->
	<select id="getList" resultType="java.util.HashMap">
       	SELECT
			fe.id ent_id,
			fe.check_emp_id entrust_id,
			fe.check_emp_name entrust_name,
			fe.ent_emp_id entrusted_id,
			fe.ent_emp_name entrusted_name,
			fe.create_date_time,
			fb.id fb_id,
			fb.t_code,
			fb.t_name,
			fb.t_desc,
			t1.id t_type_id,
			t1.t_name t_type_name,
			t2.id parent_t_type_id,
			t2.t_name parent_t_type_name,
			fm.id fm_id,
			fm.t_name fm_name
		FROM
			fb_bus_entrust fe 
		JOIN fb_bus_template fb ON fe.fb_code = fb.t_code
		JOIN fb_bus_type t1 ON fb.f_b_t_id = t1.id
		JOIN fb_bus_type t2 ON fb.parent_id = t2.id
		 JOIN fb_bus_fm bm ON fb.id = bm.fb_id
		 JOIN fm_bus_template fm ON fm.id = bm.fm_id
		WHERE
			 fb.t_enabled='2' and fe.ent_enabled='1'
		<if test="ent_flag == 0 ">
                AND fe.check_emp_id = #{emp_id}
		</if>
		<if test="ent_flag == 1 ">
                AND fe.ent_emp_id = #{emp_id}
		</if>
		<if test="t_code != null and t_code !=''">
                AND fb.t_code =  #{t_code}
		</if>
		<if test="t_name != null and t_name !=''">
                AND fb.t_name  LIKE CONCAT (#{t_name},'%')
		</if>
		<if test="entrusted_name != null and entrusted_name !=''">
                AND fe.ent_emp_name LIKE CONCAT('%', #{entrusted_name},'%') 
		</if>
		<if test="entrust_name != null and entrust_name !=''">
                AND fe.check_emp_name LIKE CONCAT('%', #{entrust_name},'%') 
		</if>
		<if test="t_type_name != null and t_type_name !=''">
                AND t1.t_name LIKE CONCAT(#{t_type_name},'%')
		</if>
		<if test="parent_t_type_name != null and parent_t_type_name !=''">
                AND t2.t_name LIKE CONCAT(#{parent_t_type_name},'%')
		</if>   
	</select>
	
	<!--app获取委托流程列表-->
	<select id="getAppEntrustList" resultType="java.util.HashMap">
       	SELECT
			tt.id fb_id,
			tt.t_code,
			tt.t_name,
			tt.t_desc,
			tt.t_enabled,
			tt.model_id,
			t1.id t_type_id,
			t1.t_name t_type_name,
  			fe.id ent_id,
 		    fe.ent_emp_id entrusted_id,
  			fe.ent_emp_name entrusted_name,
  			(CASE WHEN fe.id IS NOT NULL AND fe.check_emp_id=#{emp_id} THEN '1' ELSE '0' END) entrust_status
		FROM
			fb_bus_template tt
		JOIN fb_bus_type t1 ON tt.f_b_t_id = t1.id
		LEFT JOIN (SELECT * FROM fb_bus_entrust fe WHERE fe.check_emp_id=#{emp_id} and fe.ent_enabled='1') fe ON fe.fb_code = tt.t_code
		WHERE
			tt.t_enabled = '2'
		<if test="t_code != null and t_code !=''">
                AND tt.t_code =  #{t_code}
		</if>
		<if test="t_name != null and t_name !=''">
                AND tt.t_name  LIKE CONCAT (#{t_name},'%')
		</if>
		<if test="entrusted_name != null and entrusted_name !=''">
                AND fe.ent_emp_name =#{entrusted_name}
		</if>
		<if test="entrust_status == '0'">
                AND fe.id is null
		</if>
		<if test="entrust_status == '1'">
                AND fe.id is not null
		</if>
		<if test="t_type_name != null and t_type_name !=''">
                AND t1.t_name LIKE CONCAT(#{t_type_name},'%')
		</if>
	</select>
	
	
	<!--app获取我委托的和委托我的流程列表-->
	<select id="getAppList" resultType="java.util.HashMap">
       	SELECT
			fe.id ent_id,
			fe.check_emp_id entrust_id,
			fe.check_emp_name entrust_name,
			fe.ent_emp_id entrusted_id,
			fe.ent_emp_name entrusted_name,
			fe.create_date_time,
			fb.id fb_id,
			fb.t_code,
			fb.t_name,
			fb.t_desc,
			t1.id t_type_id,
			t1.t_name t_type_name,
			fm.id fm_id,
			fm.t_name fm_name
		FROM
			fb_bus_entrust fe
		JOIN fb_bus_template fb ON fe.fb_code = fb.t_code
		JOIN fb_bus_type t1 ON fb.f_b_t_id = t1.id
	    JOIN fb_bus_fm bm ON fb.id = bm.fb_id
	    JOIN fm_bus_template fm ON fm.id = bm.fm_id
		WHERE
			fb.t_enabled='2' and fe.ent_enabled='1'
		<if test="ent_flag == 0 ">
                AND fe.check_emp_id = #{emp_id}
		</if>
		<if test="ent_flag == 1 ">
                AND fe.ent_emp_id = #{emp_id}
		</if>
		<if test="t_code != null and t_code !=''">
                AND fb.t_code =  #{t_code}
		</if>
		<if test="t_name != null and t_name !=''">
                AND fb.t_name  LIKE CONCAT (#{t_name},'%')
		</if>
		<if test="entrusted_name != null and entrusted_name !=''">
                AND fe.ent_emp_name LIKE CONCAT('%', #{entrusted_name},'%') 
		</if>
		<if test="entrust_name != null and entrust_name !=''">
                AND fe.check_emp_name LIKE CONCAT('%', #{entrust_name},'%') 
		</if>
		<if test="t_type_name != null and t_type_name !=''">
                AND t1.t_name LIKE CONCAT(#{t_type_name},'%')
		</if>
	</select>
	
	<!--根据发起id找原审核人信息-->
	<select id="getOldEmp" parameterType="String" resultType="java.util.HashMap">
       	SELECT
			check_emp_id,
			check_emp_name,
			ent_emp_id,
			ent_emp_name
		FROM
			fb_bus_entrust fbe
		JOIN fb_bus_inst fbi ON fbi.fb_id = fbe.fb_id
		WHERE
			fbi.id = #{instId}
	</select>
  	
</mapper>