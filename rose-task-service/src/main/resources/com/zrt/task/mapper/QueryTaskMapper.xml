<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.zrt.task.mapper.task.QueryTaskMapper" >

  	<select id="searchTask" resultType="java.util.HashMap">
	   select 	DISTINCT
	   			task.task_id,
  		 		task.task_name,
				task.task_start_time,
				task.parent_task_id,
				task.task_end_time,
				task.task_state,
				task.task_owner,
				task.task_owner_name,
				task.create_date_time,
				task.update_date_time 
				from 
				task left join task_executor 
				on task.task_id = task_executor.task_id
				where 1=1
				<if test="task_name != null and task_name !=''">
				and task.task_name LIKE CONCAT('%',#{task_name},'%')  
				</if>
				<if test="executor_id != null and executor_id !=''">
				and task_executor.emp_id = #{executor_id}  
				</if>
		<!-- 任务开始时间的开始和结束判断-->		
				<if test="start_time_start != null and start_time_start !=''">
					<if test="start_time_end != null and start_time_end !=''">
						and  task.task_start_time >=#{start_time_start}  and #{start_time_end} >= task.task_start_time
					</if>
					<if test="start_time_end == null or start_time_end ==''">
						and  task.task_start_time >= #{start_time_start}
					</if>
				</if>
				<if test="start_time_start == null or start_time_start ==''">
					<if test="start_time_end != null and start_time_end !=''">
						and  #{start_time_end} >= task.task_start_time
					</if>
				</if>
				
		<!-- 任务结束时间的开始和结束判断-->		
				<if test="end_time_start != null and end_time_start !=''">
					<if test="end_time_end != null and end_time_end !=''">
						and task.task_end_time >= #{end_time_start} and #{end_time_end} >= task.task_end_time
					</if>
					<if test="end_time_end == null or end_time_end ==''">
						and  task.task_end_time >= #{end_time_start}
					</if>
				</if>
				<if test="end_time_start == null or end_time_start ==''">
					<if test="end_time_end != null and end_time_end !=''">
						and  #{end_time_end} >= task.task_end_time
					</if>
				</if>
				
				<if test="task_owner != null and task_owner !=''">
				and task.task_owner = #{task_owner}  
					<if test="executorName != null and executorName !=''">
				 and task_executor.emp_name LIKE CONCAT('%',#{executorName},'%')   
					</if>
				</if>
				<if test="taskexecutor != null and taskexecutor !=''">
				and task_executor.emp_id = #{taskexecutor} 
					<if test="taskOwnerName != null and taskOwnerName !=''">
				and task.task_owner_name LIKE CONCAT('%',#{taskOwnerName},'%') and	task_executor.emp_id = #{emp_id}	
					</if>
				</if>
				<if test="task_state != null and task_state !=''">
					<if test="task_state != 4">
					and task.task_state = #{task_state} 
					</if>
					<if test="task_state == 4 ">
					and task.task_state = 1 and  #{now_time} > task_end_time
					</if> 
				</if>
				<if test="parent_task_id != null and parent_task_id !=''">
				and task.parent_task_id = #{parent_task_id} 
				</if>
		ORDER BY create_date_time DESC
  	</select>
  	
  	
  	<select id="webSearchTask" resultType="java.util.HashMap">
	   select  DISTINCT
	   			task.task_id,
  		 		task.task_name,
				task.task_start_time,
				task.parent_task_id,
				task.task_end_time,
				task.task_state,
				task.task_owner,
				task.task_owner_name,
				task.create_date_time,
				task.update_date_time 
				from 
				task left join task_executor 
				on task.task_id = task_executor.task_id
				where 1=1
				<if test="executor_id != null and executor_id !=''">
				and (task_executor.emp_id = #{executor_id}  or task.task_owner = #{emp_id})
				</if>
				<if test="taskOwnerName != null and taskOwnerName !=''">
					<if test="executorName == null or executorName ==''">
					and task.task_owner_name LIKE CONCAT('%',#{taskOwnerName},'%') and task_executor.emp_id = #{emp_id}
					</if>
					<if test="executorName != null and executorName !=''">
				and ((task.task_owner_name LIKE CONCAT('%',#{taskOwnerName},'%') and task_executor.emp_id = #{emp_id})
				or (task.task_owner = #{emp_id} and task_executor.emp_name LIKE CONCAT('%',#{executorName},'%')))
					</if>
				</if> 
				<if test="taskOwnerName == null or taskOwnerName ==''">
					<if test="executorName != null and executorName !=''">
				and task.task_owner  = #{emp_id}  and task_executor.emp_name LIKE CONCAT('%',#{executorName},'%')
					</if>	
				</if> 
				<if test="task_name != null and task_name !=''">
				and task.task_name LIKE CONCAT('%',#{task_name},'%')  
				</if>
		<!-- 任务开始时间的开始和结束判断-->		
				<if test="start_time_start != null and start_time_start !=''">
					<if test="start_time_end != null and start_time_end !=''">
						and  task.task_start_time >= #{start_time_start} and #{start_time_end} >= task.task_start_time
					</if>
					<if test="start_time_end == null or start_time_end ==''">
						and  task.task_start_time >= #{start_time_start}
					</if>
				</if>
				<if test="start_time_start == null or start_time_start ==''">
					<if test="start_time_end != null and start_time_end !=''">
						and  #{start_time_end} >= task.task_start_time 
					</if>
				</if>
				
		<!-- 任务结束时间的开始和结束判断-->		
				<if test="end_time_start != null and end_time_start !=''">
					<if test="end_time_end != null and end_time_end !=''">
						and task.task_end_time >= #{end_time_start} and #{end_time_end} >= task.task_end_time
					</if>
					<if test="end_time_end == null or end_time_end ==''">
						and  task.task_end_time >= #{end_time_start} 
					</if>
				</if>
				<if test="end_time_start == null or end_time_start ==''">
					<if test="end_time_end != null and end_time_end !=''">
						and  #{end_time_end} >= task.task_end_time
					</if>
				</if>
				 
				<if test="task_state != null and task_state !=''">
					<if test="task_state != 4">
					and task.task_state = #{task_state} 
					</if>
					<if test="task_state == 4">
					and task.task_state = 1 and  #{now_time} > task_end_time
					</if> 
				</if>
				<if test="parent_task_id != null and parent_task_id !=''">
				and task.parent_task_id = #{parent_task_id} 
				</if>
		ORDER BY create_date_time DESC
  	</select>
  	
  	
  	<select id="searchTaskByExecutor" resultType="java.util.HashMap">
  		 select task.task_id,
  		 		task.task_name,
				task.task_start_time,
				task.parent_task_id,
				task.task_end_time,
				task.task_state,
				task.task_owner,
				task.task_owner_name,
				task.create_date_time,
				task.update_date_time 
				from 
				task left join task_executor
				on task.task_id = task_executor.task_id
				where 1=1
				<if test="task_name != null and task_name !=''">
				and task_name LIKE CONCAT('%',#{task_name},'%')  
				</if>
				<if test="executor_id != null and executor_id !=''">
				and emp_id = #{executor_id}  
				</if>
		<!-- 任务开始时间的开始和结束判断-->		
				<if test="start_time_start != null and start_time_start !=''">
					<if test="start_time_end != null and start_time_end !=''">
						and  task_start_time >= #{start_time_start} and #{start_time_end} >= task_start_time
					</if>
					<if test="start_time_end == null or start_time_end ==''">
						and  task_start_time >= #{start_time_start}
					</if>
				</if>
				<if test="start_time_start == null or start_time_start ==''">
					<if test="start_time_end != null and start_time_end !=''">
						and  #{start_time_end} >= task_start_time 
					</if>
				</if>
				
		<!-- 任务结束时间的开始和结束判断-->		
				<if test="end_time_start != null and end_time_start !=''">
					<if test="end_time_end != null and end_time_end !=''">
						and task_end_time >= #{end_time_start} and #{end_time_end} >= task_end_time
					</if>
					<if test="end_time_end == null or end_time_end ==''">
						and  task_end_time >= #{end_time_start}  
					</if>
				</if>
				<if test="start_time_start == null or start_time_start ==''">
					<if test="end_time_end != null and end_time_end !=''">
						and  #{end_time_end} >=task_end_time
					</if>
				</if>
				
				<if test="taskOwnerName != null and taskOwnerName !=''">
				and task_owner_name LIKE CONCAT('%',#{taskOwnerName},'%') and emp_id = #{emp_id} 
					<if test="executorName != null and executorName !=''">
				or (task_owner = #{emp_id} and emp_name LIKE CONCAT('%',#{executorName},'%'))
					</if>
				</if>
				<if test="taskOwnerName == null or taskOwnerName ==''">
				and task_owner = #{emp_id} 
					<if test="executorName != null and executorName !=''">
				and emp_name LIKE CONCAT('%',#{executorName},'%'))
					</if>	
				</if>
				<if test="task_state != null and task_state !=''">
				and task_state = #{task_state} 
				</if>
				<if test="parent_task_id != null and parent_task_id !=''">
				and parent_task_id = #{parent_task_id} 
				</if>
		ORDER BY create_date_time DESC
  	</select>
  	
  	
  	
  	
  	<select id="searchTaskByState" resultType="java.util.HashMap">
  		 select task.task_id,
  		 		task.task_name,
				task.task_start_time,
				task.task_end_time,
				task.task_state,
				task.task_owner,
				task.task_owner_name,
				task.update_date_time,
				task.task_owner_name,
				task.create_date_time,
				taskExecutor.back_percent 
				from 
				task task left join task_executor taskExecutor
				on task.task_id = taskExecutor.task_id
				WHERE emp_id = #{emp_id}
				<if test="task_name != null and task_name !=''">
				and task_name LIKE CONCAT('%',#{task_name},'%')  
				</if>
				<if test="taskOwnerName  != null and taskOwnerName  !=''">
				and task_owner_name  LIKE CONCAT('%',#{taskOwnerName },'%')  
				</if>
		<!-- 任务开始时间的开始和结束判断-->		
				<if test="start_time_start != null and start_time_start !=''">
					<if test="start_time_end != null and start_time_end !=''">
						and  task_start_time >= #{start_time_start} and #{start_time_end} >= task_start_time
					</if>
					<if test="start_time_end == null or start_time_end ==''">
						and  task_start_time >= #{start_time_start}
					</if>
				</if>
				<if test="start_time_start == null or start_time_start ==''">
					<if test="start_time_end != null and start_time_end !=''">
						and  #{start_time_end} >= task_start_time
					</if>
				</if>
				
		<!-- 任务结束时间的开始和结束判断-->		
				<if test="end_time_start != null and end_time_start !=''">
					<if test="end_time_end != null and end_time_end !=''">
						and task_end_time >= #{end_time_start} and #{end_time_end} >= task_end_time
					</if>
					<if test="end_time_end == null or end_time_end ==''">
						and  task_end_time >= #{end_time_start}
					</if>
				</if>
				<if test="end_time_start == null or end_time_start ==''">
					<if test="end_time_end != null and end_time_end !=''">
						and  #{end_time_end} >= task_end_time
					</if>
				</if>
				<if test="task_executor_state != null and task_executor_state !=''">
				and task_executor_state = #{task_executor_state} 
				</if>
				<if test="parent_task_id != null and parent_task_id !=''">
				and parent_task_id = #{parent_task_id} 
				</if>
		ORDER BY create_date_time DESC
  	</select>
  	
  	<select id="attach" resultType="java.util.HashMap">
		select task_attack_id ,
			   attach_id ,
			   node_id,
			   attach_type,   
			   remark,
			   create_date_time,
			   update_date_time,
			   task_attach_url,
			   attach_name
			   from
			   task_attach
			   where
			   task_id = #{task_id}  
		ORDER BY tenant_id
  	</select>
  	
  	
  	<select id="executor" resultType="java.util.HashMap">
  		select  task_emp_id,
				task_id,
				emp_id,
				emp_name,
				back_time,
				back_remark,
				back_percent,
				remark,
				create_date_time,
				update_date_time,
				is_read,
				task_executor_state
				from 
				task_executor
				where 1=1
				<if test="task_id != null and task_id !=''">
				and task_id = #{task_id}
				</if>
				<if test="hand_id != null and hand_id !=''">
				and emp_id =  #{hand_id}
				</if>
				<if test="task_executor_state != null and task_executor_state !=''">
				and task_executor_state = #{task_executor_state} 
				</if>
				<if test="executor_id != null and executor_id !=''">
				and emp_id = #{executor_id} 
				</if>
	
  	</select>
  	
  	
  	<select id="executorByTaskId" resultType="java.util.HashMap">
  		select distinct emp_id
				from  
				task left join task_executor 
				on task.task_id = task_executor.task_id
				where task.parent_task_id = #{task_id}
	
  	</select>
  	
  	
  	<select id="maxMunber" resultType="java.util.HashMap">
  		select  COUNT(parent_task_id)
				from 
				task
				where 
				parent_task_id = #{task_id}
				and task_owner = #{emp_id}
  	</select>
  	
  	
  	
  	
  	<select id="minNumber" resultType="java.util.HashMap">
  		select  COUNT(parent_task_id)
				from 
				task
				where 
				parent_task_id = #{task_id}
				and
				task_owner = #{emp_id}
				and
				task_state = 3
				
  	</select>
  	
  	<select id="searchTaskByOwner" resultType="java.util.HashMap">
  		 select task_id,
  		 		task_name,
				task_start_time,
				parent_task_id,
				task_end_time,
				task_state,
				task_owner,
				task_owner_name,
				task.create_date_time,
				update_date_time 
				from 
				task
				where 1=1
				<if test="task_owner != null and task_owner !=''">
				and task_owner = #{task_owner}	
				</if>
				<if test="task_name != null and task_name !=''">
				and task.task_name LIKE CONCAT('%',#{task_name},'%')  
				</if>
				<!-- 任务开始时间的开始和结束判断-->		
				<if test="start_time_start != null and start_time_start !=''">
					<if test="start_time_end != null and start_time_end !=''">
						and  task_start_time >= #{start_time_start} and #{start_time_end} >= task_start_time
					</if>
					<if test="start_time_end == null or start_time_end ==''">
						and  task_start_time >= #{start_time_start}
					</if>
				</if>
				<if test="start_time_start == null or start_time_start ==''">
					<if test="start_time_end != null and start_time_end !=''">
						and  #{start_time_end} >= task_start_time  
					</if>
				</if>			
		<!-- 任务结束时间的开始和结束判断-->		
				<if test="end_time_start != null and end_time_start !=''">
					<if test="end_time_end != null and end_time_end !=''">
						and task_end_time >= #{end_time_start} and #{end_time_end} >= task_end_time
					</if>
					<if test="end_time_end == null or end_time_end ==''">
						and  task_end_time >= #{end_time_start}  
					</if>
				</if>
				<if test="start_time_start == null or start_time_start ==''">
					<if test="end_time_end != null and end_time_end !=''">
						and  #{end_time_end} >=task_end_time
					</if>
				</if>
				<if test="parent_task_id != null and parent_task_id !=''">
				and parent_task_id = #{parent_task_id} 
				</if>
			ORDER BY create_date_time DESC
  	</select>
  	
  	<select id="relevance" resultType="java.util.HashMap">
		select  rel_task_id,
				task_id,
				rel_id,
				rel_name,
				rel_type,
				create_date_time
		from	task_relevance		
		where	task_id = #{task_id}  
		and		rel_status = 1
		ORDER BY create_date_time
  	</select>
  	
</mapper>