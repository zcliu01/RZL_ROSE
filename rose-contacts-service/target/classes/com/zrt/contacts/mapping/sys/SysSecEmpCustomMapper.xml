<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.zrt.contacts.mapper.sys.SysSecEmpCustomMapper">


	<!-- APP端 组织通讯录 下 员工列表 -->
	<select id="empsList" resultType="map">
        SELECT
        sse.emp_id,sse.emp_name,sse.emp_head_photo,sso.org_name sso_org_name,sso.org_name_view org_name,sso.org_name_view,sse.emp_order,sse.emp_enabled,sse.emp_active,sse.emp_py,sse.emp_sl,UPPER(SUBSTRING(sse.emp_py,1,1))
        AS emp_first_py,sse.emp_mobile_phone
        FROM sys_sec_emp sse
        join (SELECT emp_id,team_id FROM sys_sec_emp_position WHERE is_first_org='1') ssep on ssep.emp_id=sse.emp_id
        JOIN (SELECT * FROM sys_sec_org WHERE
        sec_enabled = '1') sso ON
        sso.org_id = ssep.team_id
		<where>
            sse.emp_enabled ='1'
			<if test="map.status!= null and map.status !=''">
                AND sse.emp_active = #{map.status}
			</if>
			<if test="map.search!= null and map.search !=''">
		AND (sse.emp_name LIKE CONCAT('%',#{map.search},'%')
		OR sse.emp_code LIKE CONCAT('%',#{map.search},'%')  
	    OR sse.emp_py LIKE CONCAT('',#{map.search},'%') 
	    OR sse.emp_sl LIKE CONCAT('',#{map.search},'%')
	    OR sse.emp_mobile_phone LIKE CONCAT('',#{map.search},'%')
	    OR sse.emp_phone LIKE CONCAT('',#{map.search},'%')
	    ) 
			</if> 
            order by emp_first_py,emp_py
		</where>
	</select>

	<!--查询部门员工总数 -->
	<select id="selectEmpCount" resultType="integer">
        select count(emp_id) from sys_sec_emp
		<where>
            emp_enabled ='1'
			<if test="orgId!= null">
                and org_id = #{orgId}
			</if>
		</where>
	</select>


	<!--App端 根据部门ID 查询部门下的员工信息 -->
	<select id="empListByOrg" resultType="map">
        SELECT
        sse.emp_id,sse.emp_name,sse.emp_head_photo,spp.p_name,sse.emp_sl,sse.emp_active,sse.emp_py,UPPER(SUBSTRING(sse.emp_py,1,1))
        AS emp_first_py,ssep.org_name
        FROM sys_sec_emp sse
        join sys_sec_emp_position ssep on (ssep.emp_id=sse.emp_id and ssep.is_first_org=1)
        LEFT JOIN sys_plat_rank spr ON
        spr.r_id=ssep.r_id
        left join sys_plat_position spp ON
        spp.p_s_p_id = ssep.emp_position_id
		<where>
            sse.emp_enabled='1'
			<if test="map.org_id!= null and map.org_id!=''">
                AND ssep.team_id = #{map.org_id}
			</if>
			<if test="map.status!= null and map.status!=''">
                AND sse.emp_active = #{map.status}
			</if>
			<if test="map.search!= null and map.search !=''">
                AND (sse.emp_name LIKE CONCAT('%',#{map.search},'%')
                OR ssep.org_name LIKE CONCAT('%',#{map.search},'%')
                OR
                sse.emp_code LIKE CONCAT('%',#{map.search},'%')
                OR sse.emp_py LIKE
                CONCAT('',#{map.search},'%')
                OR sse.emp_sl LIKE
                CONCAT('',#{map.search},'%')
                )
			</if>
            ORDER BY sse.emp_order
		</where>
	</select>


	<!--App端 根据员工ID 查询直接上级员工姓名 -->
	<select id="selectUpEmpName" resultType="string">
		SELECT emp_name upEmpName FROM sys_sec_emp WHERE emp_id = #{upEmpId}
	</select>


	<!--App端 根据员工ID 查询直接上级员工信息 -->
	<select id="selectUpEmpDetails" resultType="map">
        SELECT manage_emp_id,manage_emp_name,charge_emp_id,charge_emp_name FROM sys_sec_emp sse 
        join (SELECT * FROM sys_sec_emp_position WHERE is_first_org='1') ssep on ssep.emp_id=sse.emp_id
        JOIN sys_sec_org sso ON        sso.org_id=ssep.org_id
		<where>
			<if test="friendEmpId != null">
                AND sse.emp_id = #{friendEmpId}
			</if>
		</where>
	</select>

	<!--App端 根据员工ID 查询员工详情 -->
	<select id="selectEmpDetails" resultType="map">
        SELECT
        sse.emp_id,sse.emp_code,sse.emp_name,sse.emp_birthday,sse.emp_sex,sse.emp_postcode,sse.emp_order,
        sse.emp_phone,sse.emp_mobile_phone,sse.emp_fax,sse.emp_email,sse.emp_head_photo,
        sse.emp_address,sse.emp_work_address,sse.create_date_time,sse.entry_time,sse.emp_active,sse.emp_message,sso.org_name sso_org_name,sso.org_name_owner org_name,sso.org_name_view,
        sso.manage_emp_id,sso.manage_emp_name,sso.charge_emp_id,sso.charge_emp_name,ssep.up_emp_id upEmpId
        FROM sys_sec_emp sse
        join (SELECT * FROM sys_sec_emp_position WHERE is_first_org='1') ssep on ssep.emp_id=sse.emp_id
        JOIN sys_sec_org sso ON        sso.org_id=ssep.team_id
		<where>
            1=1
			<if test="empId!= null">
                AND sse.emp_id = #{empId}
			</if>
		</where>
	</select>

	<!-- 根据员工ID 获取个人履历 -->
	<select id="selectEmpWorkRedeploy" parameterType="string"
		resultType="map">
        SELECT
        sswr.work_redeploy_id,sso.org_name,psp.p_name,sswr.create_date_time,sswr.end_date_time,sswr.redeploy_content
        FROM sys_work_redeploy sswr
        LEFT JOIN (SELECT * FROM sys_sec_org
        WHERE
        sec_enabled = '1' AND
        sec_delete_flag = '0') sso ON sso.org_id =
        sswr.org_id /*组织机构-部门*/
        LEFT JOIN (SELECT * FROM sys_plat_position
        WHERE p_status = '1') psp
        ON psp.p_s_p_id = sswr.emp_position_id /*职位*/
		<where>
			<if test="empId != null">
                sswr.emp_id = #{empId}
			</if>
		</where>
		order by sswr.create_date_time
	</select>

	<!-- 根据用户ID 获取职位讯息 -->
	<select id="selectEmpPositionDetails" parameterType="string"
		resultType="map">
        select sse.emp_id,sse.emp_name,ssep.org_id,ssep.emp_position_id,
        sso.org_name_view org_name,spp.p_name,sse2.manage_emp_id AS manage_emp_id,
        sse2.manage_emp_name AS manage_emp_name,
        sse2.charge_emp_id AS charge_emp_id,
        sse2.charge_emp_name AS charge_emp_name,
        ssep.is_first_org
        from sys_sec_emp sse
        join sys_sec_emp_position ssep on ssep.emp_id=sse.emp_id
        JOIN sys_sec_org sso ON
        sso.org_id=ssep.team_id
        left join
        sys_plat_position spp ON
        spp.p_s_p_id = ssep.emp_position_id
        LEFT JOIN sys_work_relation sse2 ON sse2.emp_id = sse.emp_id
		<where>
            1=1
			<if test="userId != null">
                and sse.emp_id = #{userId}
			</if>
			<if test="isFirstOrg != null and isFirstOrg !=''">
                AND ssep.is_first_org = #{isFirstOrg}
			</if>
			<if test="isFirstOrg = null">
                AND ssep.is_first_org = '1'
			</if>
		</where>
	</select>
	<!-- 根据用户ID 获取职位讯息 -->
	<select id="selectEmpPositionDetailsTemp" parameterType="string"
		resultType="map">
        select sse.emp_id,sse.emp_name,ssep.org_id,ssep.emp_position_id,
        sso.org_name_view org_name,spp.p_name,sse2.manage_emp_id AS manage_emp_id,
        sse2.manage_emp_name AS manage_emp_name,
        sse2.charge_emp_id AS charge_emp_id,
        sse2.charge_emp_name AS charge_emp_name,
        ssep.is_first_org
        from sys_sec_emp sse
        join sys_sec_emp_position ssep on ssep.emp_id=sse.emp_id
        JOIN sys_sec_org sso ON
        sso.org_id=ssep.team_id
        left join
        sys_plat_position spp ON
        spp.p_s_p_id = ssep.emp_position_id
        LEFT JOIN sys_work_relation sse2 ON sse2.emp_id = sse.emp_id
		<where>
            1=1
			<if test="userId != null">
                and sse.emp_id = #{userId}
			</if>
                AND ssep.is_first_org = '1'
		</where>
	</select>
	
	


	<!-- 用于IM同步通讯录 -->
	<select id="selectEmpList" resultType="map">
		SELECT sse.emp_id AS 'uid',sse.emp_name AS 'unm',sse.emp_sex AS
		'sex',sse.emp_sl AS 'fnm',sse.emp_py AS 'py',
		spp.p_name AS 'up',ssep.team_id AS 'udid',sso.parent_org_id AS
		'udpid',sse.emp_mobile_phone AS 'mtel',sse.emp_phone AS 'tel',
		sse.emp_email AS 'mail','' AS 'qq',sse.emp_head_photo AS 'url','' AS
		'sign','' AS 'md5','' AS 'voip','0' AS 'isl',
		sse.emp_order AS 'orderField','0' AS 'oltype','0' AS 'olsubtype','0' AS
		'olnetwork','1' AS 'type',
		'1' AS 'isloc','' AS 'remark','' AS 'account', sse.emp_account AS
		'oaAccount','' AS 'userLevel',sse.emp_enabled AS 'userStatus'
		FROM sys_sec_emp sse
		join (SELECT * FROM sys_sec_emp_position WHERE is_first_org='1') ssep on ssep.emp_id=sse.emp_id
		JOIN sys_plat_position spp ON
		ssep.emp_position_id = spp.p_s_p_id
		left join sys_sec_org sso on
		sso.org_id=ssep.org_id
		

	</select>
	
	<!-- 所有在职员工 -->
	<select id="searchAll" resultType="map">
	 	SELECT
			sse.emp_id,sse.emp_name
		FROM
			sys_sec_emp sse
		JOIN (
			SELECT
				*
			FROM
				sys_sec_emp_position
			WHERE
				is_first_org = '1'
				) ssep ON ssep.emp_id = sse.emp_id
			JOIN sys_sec_org sso ON sso.org_id = ssep.team_id
			LEFT JOIN sys_plat_position psp ON ssep.emp_position_id = psp.p_s_p_id
		WHERE
			sse.emp_active = '1'
		AND sse.emp_enabled = '1'
	</select>
	
</mapper>